{
  "name": "AI Token Hunter v3 - Fixed",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 5
            }
          ]
        }
      },
      "id": "trigger",
      "name": "â° Her 5 Dakika",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        0,
        300
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://api.dexscreener.com/token-profiles/latest/v1",
        "options": {
          "timeout": 15000
        }
      },
      "id": "dex-latest",
      "name": "ğŸ†• Yeni Tokenler",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        300,
        200
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://api.dexscreener.com/token-boosts/top/v1",
        "options": {
          "timeout": 15000
        }
      },
      "id": "dex-boosted",
      "name": "ğŸš€ Boosted",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        300,
        400
      ]
    },
    {
      "parameters": {
        "jsCode": "// Yeni ve Boosted tokenlerden Base olanlarÄ± al\nconst latestItems = $('ğŸ†• Yeni Tokenler').all();\nconst boostedItems = $('ğŸš€ Boosted').all();\n\nconst latestData = latestItems.length > 0 ? latestItems[0].json : [];\nconst boostedData = boostedItems.length > 0 ? boostedItems[0].json : [];\n\n// Base tokenlerini topla\nconst baseTokens = new Set();\n\n// Latest'ten Base tokenleri\nif (Array.isArray(latestData)) {\n  latestData.forEach(t => {\n    if (t.chainId === 'base' && t.tokenAddress) {\n      baseTokens.add(t.tokenAddress);\n    }\n  });\n}\n\n// Boosted'dan Base tokenleri\nif (Array.isArray(boostedData)) {\n  boostedData.forEach(t => {\n    if (t.chainId === 'base' && t.tokenAddress) {\n      baseTokens.add(t.tokenAddress);\n    }\n  });\n}\n\nconst tokenList = Array.from(baseTokens).slice(0, 30); // Max 30 token\n\nconsole.log('Base tokenleri bulundu:', tokenList.length);\n\nreturn {\n  json: {\n    tokens: tokenList,\n    count: tokenList.length,\n    latestCount: Array.isArray(latestData) ? latestData.filter(t => t.chainId === 'base').length : 0,\n    boostedCount: Array.isArray(boostedData) ? boostedData.filter(t => t.chainId === 'base').length : 0\n  }\n};"
      },
      "id": "collect-tokens",
      "name": "ğŸ“‹ Token Listesi",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        600,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "c1",
              "leftValue": "={{ $json.count }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "if-has-tokens",
      "name": "â“ Token Var?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        900,
        300
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://api.dexscreener.com/tokens/v1/base/{{ $json.tokens.slice(0,10).join(',') }}",
        "options": {
          "timeout": 20000
        }
      },
      "id": "dex-token-details",
      "name": "ğŸ“Š Token DetaylarÄ±",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1200,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "// Token detaylarÄ±nÄ± analiz et + Pump/Agent skorlarÄ±nÄ± ekle\nconst tokenData = $input.first().json;\nconst pairs = Array.isArray(tokenData) ? tokenData : (tokenData.pairs || []);\n\n// Opsiyonel agent sinyalleri: [{token_address, trendScore, confidence, reason}]\nlet agentMap = new Map();\ntry {\n  const a = $('ğŸ¤– Agent Sinyalleri (Base)').first().json;\n  const arr = Array.isArray(a) ? a : (a.items || a.signals || []);\n  for (const it of arr) {\n    const addr = (it.token_address || it.tokenAddress || it.address || '').toLowerCase();\n    if (!addr) continue;\n    agentMap.set(addr, {\n      trendScore: Math.max(0, Math.min(100, parseFloat(it.trendScore ?? it.score ?? 0))),\n      confidence: Math.max(0, Math.min(10, parseFloat(it.confidence ?? 0))),\n      reason: it.reason || it.note || ''\n    });\n  }\n} catch (e) {\n  agentMap = new Map();\n}\n\n// HariÃ§ tutulacak tokenler\nconst EXCLUDED = [\n  'USDC', 'USDT', 'DAI', 'USDB', 'USDBC',\n  'WETH', 'WBTC', 'CBETH', 'ETH', 'BTC'\n];\n\nconst candidates = [];\n\nfor (const pair of pairs) {\n  if (!pair.baseToken?.address) continue;\n\n  const symbol = (pair.baseToken.symbol || '').toUpperCase();\n  if (EXCLUDED.includes(symbol)) continue;\n\n  const liquidity = parseFloat(pair.liquidity?.usd || 0);\n  const volume24h = parseFloat(pair.volume?.h24 || 0);\n  const volume1h = parseFloat(pair.volume?.h1 || 0);\n  const volume5m = parseFloat(pair.volume?.m5 || 0);\n\n  const priceChange5m = parseFloat(pair.priceChange?.m5 || 0);\n  const priceChange1h = parseFloat(pair.priceChange?.h1 || 0);\n  const priceChange24h = parseFloat(pair.priceChange?.h24 || 0);\n\n  const buys24h = pair.txns?.h24?.buys || 0;\n  const sells24h = pair.txns?.h24?.sells || 0;\n  const txns24h = buys24h + sells24h;\n  const buyPressure = txns24h ? (buys24h / txns24h) : 0;\n\n  const price = parseFloat(pair.priceUsd || 0);\n  const fdv = parseFloat(pair.fdv || 0);\n\n  // Minimum gereksinimler\n  if (liquidity < 10000) continue;\n  if (volume24h < 20000) continue;\n  if (price <= 0) continue;\n\n  // --- PumpScore (0-100) ---\n  // Volume spike (0-40)\n  const volSpike = liquidity > 0 ? (volume5m / (liquidity/1000)) : 0; // kaba oran\n  const volSpikeScore = Math.min(Math.max(volSpike * 8, 0), 40);\n\n  // Buy pressure (0-25)\n  const buyScore = Math.min(Math.max((buyPressure - 0.4) * 100, 0), 25);\n\n  // Short-term momentum (0-20)\n  const momScore = Math.min(Math.max(priceChange5m * 2, 0), 20);\n\n  // Liquidity & sanity (0-15)\n  const liqScore = Math.min(Math.max((liquidity - 10000) / 1000, 0), 15);\n\n  const pumpScore = Math.round(volSpikeScore + buyScore + momScore + liqScore);\n\n  // --- AgentScore (0-100) ---\n  const a = agentMap.get(pair.baseToken.address.toLowerCase());\n  const agentScore = a ? Math.round(a.trendScore) : 0;\n\n  // FinalScore\n  const finalScore = Math.round(0.6 * pumpScore + 0.4 * agentScore);\n\n  // Eski skorla uyumluluk iÃ§in \"score\" alanÄ±na finalScore koyuyoruz\n  candidates.push({\n    symbol: pair.baseToken.symbol,\n    name: pair.baseToken.name || symbol,\n    address: pair.baseToken.address,\n    pairAddress: pair.pairAddress,\n    price,\n    priceChange5m,\n    priceChange1h,\n    priceChange24h,\n    volume24h: Math.round(volume24h),\n    volume1h: Math.round(volume1h),\n    volume5m: Math.round(volume5m),\n    liquidity: Math.round(liquidity),\n    fdv: Math.round(fdv),\n    txns24h,\n    buys24h,\n    buyPressure: (buyPressure * 100).toFixed(1) + '%',\n    pumpScore,\n    agentScore,\n    finalScore,\n    score: finalScore,\n    agentReason: a?.reason || '',\n    dexUrl: `https://dexscreener.com/base/${pair.pairAddress}`\n  });\n}\n\ncandidates.sort((a, b) => b.finalScore - a.finalScore);\nconst topTokens = candidates.slice(0, 5);\n\nreturn {\n  json: {\n    topTokens,\n    bestToken: topTokens[0] || null,\n    totalAnalyzed: pairs.length,\n    qualified: candidates.length,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "analyze",
      "name": "ğŸ” Analiz",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1500,
        200
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "c1",
              "leftValue": "={{ $json.bestToken }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "if-best-token",
      "name": "â“ En Ä°yi?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1800,
        200
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-api-key",
              "value": "={{ $env.ANTHROPIC_API_KEY }}"
            },
            {
              "name": "anthropic-version",
              "value": "2023-06-01"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"claude-sonnet-4-20250514\",\n  \"max_tokens\": 1024,\n  \"messages\": [{\n    \"role\": \"user\",\n    \"content\": \"Base memecoin trader ajanÄ±sÄ±n. Pump eden tokenleri analiz et.\\n\\nğŸ¯ Strateji: TP +20%, SL -10%, Max 5 USDC\\n\\nğŸ“Š TOP TOKENLER:\\n{{ JSON.stringify($json.topTokens, null, 2) }}\\n\\nğŸ† EN Ä°YÄ°:\\n- Symbol: {{ $json.bestToken.symbol }}\\n- Fiyat: ${{ $json.bestToken.price }}\\n- 5dk: {{ $json.bestToken.priceChange5m }}%\\n- 1s: {{ $json.bestToken.priceChange1h }}%\\n- 24s: {{ $json.bestToken.priceChange24h }}%\\n- Hacim: ${{ $json.bestToken.volume24h }}\\n- Likidite: ${{ $json.bestToken.liquidity }}\\n- AlÄ±m BaskÄ±sÄ±: {{ $json.bestToken.buyPressure }}\\n- Skor: {{ $json.bestToken.score }}\\n\\nâš ï¸ RED FLAGS:\\n- 1s > %50 = Ã§ok geÃ§\\n- Likidite < $10k = rug riski\\n- AlÄ±m < %40 = dump\\n\\nSADECE JSON:\\n{\\n  \\\"action\\\": \\\"BUY\\\" veya \\\"SKIP\\\",\\n  \\\"token_symbol\\\": \\\"...\\\",\\n  \\\"token_address\\\": \\\"0x...\\\",\\n  \\\"confidence\\\": 1-10,\\n  \\\"amount_usdc\\\": 0-5,\\n  \\\"entry_price\\\": fiyat,\\n  \\\"take_profit_price\\\": fiyat*1.20,\\n  \\\"stop_loss_price\\\": fiyat*0.90,\\n  \\\"reason\\\": \\\"tÃ¼rkÃ§e\\\",\\n  \\\"risk_level\\\": \\\"LOW/MEDIUM/HIGH\\\"\\n}\"\n  }]\n}"
      },
      "id": "ai-decision",
      "name": "ğŸ§  AI",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2100,
        100
      ]
    },
    {
      "parameters": {
        "jsCode": "const aiResponse = $input.first().json;\nconst trendingData = $('ğŸ” Analiz').first().json;\n\nlet decision;\ntry {\n  const content = aiResponse.content?.[0]?.text || '';\n  const jsonMatch = content.match(/\\{[\\s\\S]*\\}/);\n  decision = jsonMatch ? JSON.parse(jsonMatch[0]) : null;\n  if (!decision) throw new Error('JSON yok');\n} catch (e) {\n  decision = { action: 'SKIP', confidence: 0, reason: 'Parse error: ' + e.message };\n}\n\nconst shouldBuy = decision.action === 'BUY' && decision.confidence >= 7 && decision.amount_usdc > 0;\n\nreturn {\n  json: {\n    ...decision,\n    shouldBuy,\n    trendingData,\n    walletAddress: '0x27650088aD441cE2a10256381246F952F80d51b3',\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "parse-ai",
      "name": "ğŸ¯ Parse",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2400,
        100
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "c1",
              "leftValue": "={{ $json.shouldBuy }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "if-buy",
      "name": "â“ AlÄ±m?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2700,
        100
      ]
    },
    {
      "parameters": {
        "jsCode": "const d = $input.first().json;\nconst USDC = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913';\nconst amt = Math.min(d.amount_usdc || 5, 5);\n\nreturn {\n  json: {\n    action: 'BUY',\n    sellToken: USDC,\n    buyToken: d.token_address,\n    sellAmount: Math.floor(amt * 1000000).toString(),\n    amountUsdc: amt,\n    tokenSymbol: d.token_symbol,\n    slippageBps: '500',\n    chainId: '8453',\n    takerAddress: '0x27650088aD441cE2a10256381246F952F80d51b3',\n    entryPrice: d.entry_price,\n    takeProfitPrice: d.take_profit_price,\n    stopLossPrice: d.stop_loss_price,\n    reason: d.reason,\n    confidence: d.confidence\n  }\n};"
      },
      "id": "prep-buy",
      "name": "ğŸ’° Params",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3000,
        0
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://api.0x.org/swap/allowance-holder/quote",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "chainId",
              "value": "={{ $json.chainId }}"
            },
            {
              "name": "sellToken",
              "value": "={{ $json.sellToken }}"
            },
            {
              "name": "buyToken",
              "value": "={{ $json.buyToken }}"
            },
            {
              "name": "sellAmount",
              "value": "={{ $json.sellAmount }}"
            },
            {
              "name": "taker",
              "value": "={{ $json.takerAddress }}"
            },
            {
              "name": "slippageBps",
              "value": "={{ $json.slippageBps }}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "0x-api-key",
              "value": "={{ $env.ZEROX_API_KEY }}"
            },
            {
              "name": "0x-version",
              "value": "v2"
            }
          ]
        },
        "options": {
          "timeout": 15000
        }
      },
      "id": "0x-quote",
      "name": "ğŸ“¡ 0x",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3300,
        0
      ]
    },
    {
      "parameters": {
        "jsCode": "const quote = $input.first().json;\nconst params = $('ğŸ’° Params').first().json;\n\nif (quote.code || quote.reason || !quote.transaction) {\n  return { json: { success: false, error: quote.reason || 'Quote failed', params } };\n}\n\nconst tx = quote.transaction;\nconst buyAmt = (parseFloat(quote.buyAmount || 0) / 1e18).toFixed(6);\n\nreturn {\n  json: {\n    success: true,\n    tokenSymbol: params.tokenSymbol,\n    tokenAddress: params.buyToken,\n    amountUsdc: params.amountUsdc,\n    buyAmountFormatted: buyAmt + ' ' + params.tokenSymbol,\n    entryPrice: params.entryPrice,\n    takeProfitPrice: params.takeProfitPrice,\n    stopLossPrice: params.stopLossPrice,\n    reason: params.reason,\n    confidence: params.confidence,\n    needsAllowance: quote.issues?.allowance?.actual === '0',\n    allowanceTarget: quote.allowanceTarget,\n    transaction: { to: tx.to, data: tx.data, value: tx.value, gas: tx.gas },\n    sellToken: params.sellToken,\n    sellAmount: params.sellAmount,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "prep-tx",
      "name": "ğŸ” TX",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3600,
        0
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://ai-trade-bot-backend.vercel.app/api/execute-trade",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ 'Bearer ' + $env.EXECUTOR_SECRET }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"transaction\": {{ JSON.stringify($json.transaction) }},\n  \"action\": \"BUY\",\n  \"needsAllowance\": {{ $json.needsAllowance }},\n  \"allowanceTarget\": \"{{ $json.allowanceTarget }}\",\n  \"sellToken\": \"{{ $json.sellToken }}\",\n  \"sellAmount\": \"{{ $json.sellAmount }}\"\n}",
        "options": {
          "timeout": 60000
        }
      },
      "id": "execute",
      "name": "ğŸš€ Execute",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3900,
        0
      ]
    },
    {
      "parameters": {
        "chatId": "500862249",
        "text": "=ğŸ¯ *ALIM YAPILDI!*\n\nğŸŸ¢ *{{ $('ğŸ” TX').item.json.tokenSymbol }}*\n\nğŸ’µ {{ $('ğŸ” TX').item.json.amountUsdc }} USDC\nğŸª™ {{ $('ğŸ” TX').item.json.buyAmountFormatted }}\nğŸ¯ GiriÅŸ: ${{ $('ğŸ” TX').item.json.entryPrice }}\nâœ… TP: ${{ $('ğŸ” TX').item.json.takeProfitPrice }}\nğŸ›‘ SL: ${{ $('ğŸ” TX').item.json.stopLossPrice }}\n\nğŸ“ {{ $('ğŸ” TX').item.json.reason }}\n\nğŸ”— `{{ $json.txHash }}`\nğŸ” [BaseScan]({{ $json.explorerUrl }})",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "tg-success",
      "name": "ğŸ“± OK",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        4200,
        0
      ]
    },
    {
      "parameters": {
        "chatId": "500862249",
        "text": "=ğŸ“Š *TARAMA*\n\nAnaliz: {{ $json.totalAnalyzed }} pair\nUygun: {{ $json.qualified }} token\n\n{{ $json.bestToken ? 'ğŸ† *' + $json.bestToken.symbol + '*\\nğŸ’µ $' + $json.bestToken.price + '\\nğŸ“ˆ 1s: ' + $json.bestToken.priceChange1h + '%\\nğŸ’§ Liq: $' + $json.bestToken.liquidity + '\\nâ­ Skor: ' + $json.bestToken.score + '\\nğŸ”— [DexScreener](' + $json.bestToken.dexUrl + ')' : 'âŒ Token yok' }}\n\nâ° {{ $json.timestamp }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "tg-scan",
      "name": "ğŸ“± Scan",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2100,
        350
      ]
    },
    {
      "parameters": {
        "chatId": "500862249",
        "text": "=â¸ï¸ *SKIP*\n\nğŸª™ {{ $json.token_symbol || 'N/A' }}\nğŸ“ {{ $json.reason }}\nğŸ¯ GÃ¼ven: {{ $json.confidence }}/10\nâš ï¸ {{ $json.risk_level }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "tg-skip",
      "name": "ğŸ“± Skip",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        3000,
        200
      ]
    },
    {
      "parameters": {
        "chatId": "500862249",
        "text": "=âŒ *TOKEN YOK*\n\nBase'de yeni/boosted token bulunamadÄ±.\n\nğŸ“Š Latest: {{ $json.latestCount }}\nğŸš€ Boosted: {{ $json.boostedCount }}\n\nâ° Tekrar taranacak...",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "tg-no-token",
      "name": "ğŸ“± Yok",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1200,
        450
      ]
    },
    {
      "parameters": {
        "content": "## ğŸ¯ Token Hunter v3\n\n### API'ler:\n- /token-profiles/latest\n- /token-boosts/top\n- /tokens/v1/base/{addresses}\n\n### Strateji:\n- TP: +20%\n- SL: -10%\n- Max: 5 USDC\n\n### Ayarla:\n- EXECUTOR_SECRET_BURAYA\n- Telegram credential\n\n### Yeni:\n- ğŸ”¥ Pump Pairs taramasÄ± (Base)\n- ğŸ¤– Agent sinyalleri (opsiyonel)\n- ğŸ§© Merge list\n- ğŸ—‚ï¸ Pozisyon kaydÄ±\n- â±ï¸ Pozisyon takip + SELL\n\n### ENV:\n- ANTHROPIC_API_KEY\n- ZEROX_API_KEY\n- EXECUTOR_SECRET\n",
        "height": 280,
        "width": 250,
        "color": 5
      },
      "id": "note",
      "name": "ğŸ“‹",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -200,
        150
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://api.dexscreener.com/latest/dex/pairs/base",
        "options": {
          "timeout": 15000
        }
      },
      "id": "dex-pump-fae841d4",
      "name": "ğŸ”¥ Pump Pairs (Base)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        300,
        600
      ]
    },
    {
      "parameters": {
        "jsCode": "// Pump/trending pair listesinden Base token adreslerini Ã§Ä±kar\n// Not: DexScreener endpoint yanÄ±t formatÄ± deÄŸiÅŸebilir. Bu kod hem {pairs:[...]} hem de direkt [...] listelerini dener.\nconst raw = $input.first().json;\nconst pairs = Array.isArray(raw) ? raw : (raw.pairs || []);\n\nconst tokens = new Set();\n\nfor (const p of pairs) {\n  // baseToken address\n  const addr = p.baseToken?.address || p.baseTokenAddress || p.tokenAddress;\n  const chain = (p.chainId || p.chain || '').toLowerCase();\n  if (!addr) continue;\n  if (chain && chain !== 'base') continue;\n\n  // Basit pump filtresi (Ã§ok agresif deÄŸil): 5dk pozitif + 24h volume/liq makul\n  const liq = parseFloat(p.liquidity?.usd || p.liquidityUsd || 0);\n  const vol24 = parseFloat(p.volume?.h24 || p.volumeH24 || 0);\n  const ch5 = parseFloat(p.priceChange?.m5 || p.priceChangeM5 || 0);\n  const buys = p.txns?.h24?.buys || 0;\n  const sells = p.txns?.h24?.sells || 0;\n  const tx = buys + sells;\n  const buyPressure = tx ? (buys/tx) : 0;\n\n  if (liq < 10000) continue;\n  if (vol24 < 20000) continue;\n  if (ch5 < 3) continue;\n  if (buyPressure < 0.45) continue;\n\n  tokens.add(addr);\n}\n\nconst tokenList = Array.from(tokens).slice(0, 30);\n\nreturn {\n  json: {\n    pumpTokens: tokenList,\n    pumpCount: tokenList.length,\n    pumpPairsAnalyzed: pairs.length,\n    pumpTimestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "pump-list-602ea23f",
      "name": "ğŸ”¥ Pump Token Listesi",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        600,
        600
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://ai-trade-bot-backend.vercel.app/api/agent-signals?chain=base",
        "options": {
          "timeout": 15000
        }
      },
      "id": "agent-signals-84014bfc",
      "name": "ğŸ¤– Agent Sinyalleri (Base)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        600,
        760
      ]
    },
    {
      "parameters": {
        "jsCode": "// Token listelerini birleÅŸtir: (1) yeni/boosted base tokens (tokens)\n// (2) pumpTokens (pump listesi)\n// (3) agentSignals iÃ§inden gelen tokenlar (opsiyonel)\n\nconst baseList = $('ğŸ“‹ Token Listesi').first().json?.tokens || [];\nconst pumpList = $('ğŸ”¥ Pump Token Listesi').first().json?.pumpTokens || [];\n\nlet agentList = [];\ntry {\n  const a = $('ğŸ¤– Agent Sinyalleri (Base)').first().json;\n  // Beklenen format Ã¶rneÄŸi: [{token_address:'0x..', trendScore:80}, ...]\n  const arr = Array.isArray(a) ? a : (a.items || a.signals || []);\n  agentList = arr.map(x => x.token_address || x.tokenAddress || x.address).filter(Boolean);\n} catch (e) {\n  agentList = [];\n}\n\nconst merged = new Set([...baseList, ...pumpList, ...agentList]);\nconst tokenList = Array.from(merged).slice(0, 30);\n\nreturn {\n  json: {\n    tokens: tokenList,\n    count: tokenList.length,\n    latestCount: $('ğŸ“‹ Token Listesi').first().json?.latestCount || 0,\n    boostedCount: $('ğŸ“‹ Token Listesi').first().json?.boostedCount || 0,\n    pumpCount: $('ğŸ”¥ Pump Token Listesi').first().json?.pumpCount || 0,\n    agentCount: agentList.length,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "merge-ec950c35",
      "name": "ğŸ§© Token Merge",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        820,
        460
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://ai-trade-bot-backend.vercel.app/api/positions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ 'Bearer ' + $env.EXECUTOR_SECRET }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"tokenSymbol\": \"{{ $('ğŸ” TX').item.json.tokenSymbol }}\",\n  \"tokenAddress\": \"{{ $('ğŸ” TX').item.json.tokenAddress }}\",\n  \"amountUsdc\": {{ $('ğŸ” TX').item.json.amountUsdc }},\n  \"entryPrice\": {{ $('ğŸ” TX').item.json.entryPrice }},\n  \"takeProfitPrice\": {{ $('ğŸ” TX').item.json.takeProfitPrice }},\n  \"stopLossPrice\": {{ $('ğŸ” TX').item.json.stopLossPrice }},\n  \"txHash\": \"{{ $json.txHash }}\",\n  \"chainId\": 8453,\n  \"takerAddress\": \"{{ $('ğŸ” TX').item.json.takerAddress || $('ğŸ’° Params').item.json.takerAddress }}\",\n  \"meta\": {\"reason\": \"{{ $('ğŸ” TX').item.json.reason }}\", \"confidence\": {{ $('ğŸ” TX').item.json.confidence }} }\n}",
        "options": {
          "timeout": 15000
        }
      },
      "id": "store-pos-c7f2cb11",
      "name": "ğŸ—‚ï¸ Position Kaydet",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4200,
        120
      ]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "seconds",
              "secondsInterval": 30
            }
          ]
        }
      },
      "id": "watch-trigger-159671f4",
      "name": "â±ï¸ Pozisyon Takip (30sn)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        0,
        900
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://ai-trade-bot-backend.vercel.app/api/positions?status=open&chainId=8453",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ 'Bearer ' + $env.EXECUTOR_SECRET }}"
            }
          ]
        },
        "options": {
          "timeout": 15000
        }
      },
      "id": "get-pos-d438cda0",
      "name": "ğŸ“¥ AÃ§Ä±k Pozisyonlar",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        300,
        900
      ]
    },
    {
      "parameters": {
        "batchSize": 10
      },
      "id": "split-85d8cba0",
      "name": "ğŸ” Split Positions",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        600,
        900
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://api.dexscreener.com/tokens/v1/base/{{ $json.tokenAddress }}",
        "options": {
          "timeout": 15000
        }
      },
      "id": "price-2d984e15",
      "name": "ğŸ“ˆ Fiyat Ã‡ek",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        900,
        900
      ]
    },
    {
      "parameters": {
        "jsCode": "// AÃ§Ä±k pozisyon iÃ§in fiyatÄ± al, TP/SL kontrol et ve SELL param hazÄ±rla\nconst pos = $input.item.json; // from split batch item\n\n// DexScreener tokens endpoint genelde pair list dÃ¶ner (array). En likit pair'Ä± seÃ§elim.\nconst raw = $('ğŸ“ˆ Fiyat Ã‡ek').item.json;\nconst pairs = Array.isArray(raw) ? raw : (raw.pairs || []);\n\nlet best = null;\nfor (const p of pairs) {\n  const liq = parseFloat(p.liquidity?.usd || 0);\n  if (!best || liq > parseFloat(best.liquidity?.usd || 0)) best = p;\n}\n\nconst price = best ? parseFloat(best.priceUsd || 0) : 0;\n\nconst tp = parseFloat(pos.takeProfitPrice || 0);\nconst sl = parseFloat(pos.stopLossPrice || 0);\n\nlet shouldSell = false;\nlet sellReason = '';\n\nif (price > 0 && tp > 0 && price >= tp) {\n  shouldSell = true;\n  sellReason = `TP hit: ${price} >= ${tp}`;\n}\nif (price > 0 && sl > 0 && price <= sl) {\n  shouldSell = true;\n  sellReason = `SL hit: ${price} <= ${sl}`;\n}\n\nreturn {\n  json: {\n    ...pos,\n    currentPrice: price,\n    shouldSell,\n    sellReason,\n    pairAddress: best?.pairAddress,\n    dexUrl: best?.pairAddress ? `https://dexscreener.com/base/${best.pairAddress}` : null\n  }\n};"
      },
      "id": "exit-1f93e807",
      "name": "ğŸ§¯ Exit Check",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1200,
        900
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "c1",
              "leftValue": "={{ $json.shouldSell }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "if-sell-f2bc6a88",
      "name": "â“ SatÄ±ÅŸ?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1500,
        900
      ]
    },
    {
      "parameters": {
        "jsCode": "const d = $input.first().json;\nconst USDC = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913';\n\n// Not: SatÄ±lacak token miktarÄ± iÃ§in backend'in 'buyAmount' saklamasÄ± idealdir.\n// EÄŸer yoksa, executor tarafÄ±nda 'sell all' desteklenmeli.\n\nreturn {\n  json: {\n    action: 'SELL',\n    sellToken: d.tokenAddress,\n    buyToken: USDC,\n    // sellAmount bilinmiyorsa executor 'sellAll' ile handle edebilir\n    sellAll: true,\n    slippageBps: '500',\n    chainId: '8453',\n    takerAddress: d.takerAddress,\n    positionId: d.id || d.positionId,\n    tokenSymbol: d.tokenSymbol,\n    currentPrice: d.currentPrice,\n    sellReason: d.sellReason,\n    dexUrl: d.dexUrl\n  }\n};"
      },
      "id": "prep-sell-689cc4f1",
      "name": "ğŸ’¸ SELL Params",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1800,
        820
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://ai-trade-bot-backend.vercel.app/api/execute-trade",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ 'Bearer ' + $env.EXECUTOR_SECRET }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"action\": \"SELL\",\n  \"sellToken\": \"{{ $json.sellToken }}\",\n  \"buyToken\": \"{{ $json.buyToken }}\",\n  \"sellAll\": {{ $json.sellAll }},\n  \"slippageBps\": \"{{ $json.slippageBps }}\",\n  \"chainId\": {{ $json.chainId }},\n  \"takerAddress\": \"{{ $json.takerAddress }}\",\n  \"positionId\": \"{{ $json.positionId }}\"\n}",
        "options": {
          "timeout": 60000
        }
      },
      "id": "exec-sell-aff07baa",
      "name": "ğŸš€ Execute SELL",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2100,
        820
      ]
    },
    {
      "parameters": {
        "chatId": "500862249",
        "text": "=ğŸ”» *SATIÅ!*\n\nğŸª™ *{{ $('ğŸ’¸ SELL Params').item.json.tokenSymbol }}*\nğŸ’µ Fiyat: ${{ $('ğŸ’¸ SELL Params').item.json.currentPrice }}\nğŸ§¾ Neden: {{ $('ğŸ’¸ SELL Params').item.json.sellReason }}\nğŸ”— {{ $('ğŸ’¸ SELL Params').item.json.dexUrl || '' }}\n\nTx: `{{ $json.txHash || '' }}`",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "tg-sell-d1a4af47",
      "name": "ğŸ“± SELL OK",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2400,
        820
      ]
    }
  ],
  "connections": {
    "â° Her 5 Dakika": {
      "main": [
        [
          {
            "node": "ğŸ†• Yeni Tokenler",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸš€ Boosted",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ”¥ Pump Pairs (Base)",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ¤– Agent Sinyalleri (Base)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ†• Yeni Tokenler": {
      "main": [
        [
          {
            "node": "ğŸ“‹ Token Listesi",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸš€ Boosted": {
      "main": [
        [
          {
            "node": "ğŸ“‹ Token Listesi",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ Token Listesi": {
      "main": [
        [
          {
            "node": "ğŸ§© Token Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â“ Token Var?": {
      "main": [
        [
          {
            "node": "ğŸ“Š Token DetaylarÄ±",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“± Yok",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š Token DetaylarÄ±": {
      "main": [
        [
          {
            "node": "ğŸ” Analiz",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Analiz": {
      "main": [
        [
          {
            "node": "â“ En Ä°yi?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â“ En Ä°yi?": {
      "main": [
        [
          {
            "node": "ğŸ§  AI",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“± Scan",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ§  AI": {
      "main": [
        [
          {
            "node": "ğŸ¯ Parse",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ¯ Parse": {
      "main": [
        [
          {
            "node": "â“ AlÄ±m?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â“ AlÄ±m?": {
      "main": [
        [
          {
            "node": "ğŸ’° Params",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“± Skip",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’° Params": {
      "main": [
        [
          {
            "node": "ğŸ“¡ 0x",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¡ 0x": {
      "main": [
        [
          {
            "node": "ğŸ” TX",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” TX": {
      "main": [
        [
          {
            "node": "ğŸš€ Execute",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸš€ Execute": {
      "main": [
        [
          {
            "node": "ğŸ—‚ï¸ Position Kaydet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”¥ Pump Pairs (Base)": {
      "main": [
        [
          {
            "node": "ğŸ”¥ Pump Token Listesi",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ¤– Agent Sinyalleri (Base)": {
      "main": [
        [
          {
            "node": "ğŸ§© Token Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”¥ Pump Token Listesi": {
      "main": [
        [
          {
            "node": "ğŸ§© Token Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ§© Token Merge": {
      "main": [
        [
          {
            "node": "â“ Token Var?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ—‚ï¸ Position Kaydet": {
      "main": [
        [
          {
            "node": "ğŸ“± OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â±ï¸ Pozisyon Takip (30sn)": {
      "main": [
        [
          {
            "node": "ğŸ“¥ AÃ§Ä±k Pozisyonlar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¥ AÃ§Ä±k Pozisyonlar": {
      "main": [
        [
          {
            "node": "ğŸ” Split Positions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Split Positions": {
      "main": [
        [
          {
            "node": "ğŸ“ˆ Fiyat Ã‡ek",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ” Split Positions",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "ğŸ“ˆ Fiyat Ã‡ek": {
      "main": [
        [
          {
            "node": "ğŸ§¯ Exit Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ§¯ Exit Check": {
      "main": [
        [
          {
            "node": "â“ SatÄ±ÅŸ?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â“ SatÄ±ÅŸ?": {
      "main": [
        [
          {
            "node": "ğŸ’¸ SELL Params",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ” Split Positions",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "ğŸ’¸ SELL Params": {
      "main": [
        [
          {
            "node": "ğŸš€ Execute SELL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸš€ Execute SELL": {
      "main": [
        [
          {
            "node": "ğŸ“± SELL OK",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ” Split Positions",
            "type": "main",
            "index": 1
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true
  },
  "tags": [],
  "triggerCount": 1
}